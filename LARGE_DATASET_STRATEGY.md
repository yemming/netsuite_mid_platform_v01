# 大量資料同步策略（幾萬筆 Transaction）

## 🔴 問題分析

### 當前架構的限制

1. **Edge Function 時間限制：60 秒**
   - 10,000 筆資料 × 200ms/筆 = 2,000 秒（33 分鐘）
   - 即使並發 15：10,000 / 15 = 667 輪 × 200ms = 133 秒（仍超過 60 秒）

2. **實際效能估算**
   - 並發數：15
   - 每筆請求時間：100-300ms（含網路延遲）
   - **10,000 筆 Invoice：約 3-5 分鐘**
   - **50,000 筆 Sales Order：約 15-25 分鐘**

## 💡 解決方案

### 方案 1：分塊處理（Chunking）- 推薦 ✅

**原理：**
- 每次 Edge Function 只處理一小塊資料（例如 500 筆）
- 完成後觸發下一個 Edge Function 繼續處理
- 利用 Supabase 的 `sync_tasks` 表追蹤進度

**優點：**
- ✅ 不需要額外基礎設施
- ✅ 利用現有的 Edge Functions
- ✅ 可以處理任意大小的資料集
- ✅ 失敗時可以從失敗點恢復

**缺點：**
- ⚠️ 需要多次 Edge Function 調用
- ⚠️ 總時間會比較長（但不會超時）

### 方案 2：使用 Inngest - 長期推薦 🚀

**原理：**
- Inngest 是專為長時間運行的 Serverless 任務設計
- 支援任務佇列、重試、錯誤處理
- 可以運行幾小時

**優點：**
- ✅ 沒有執行時間限制（或非常長）
- ✅ 自動重試和錯誤處理
- ✅ 任務佇列管理
- ✅ 有免費方案

**缺點：**
- ⚠️ 需要額外的服務（但很簡單）

### 方案 3：混合架構 - 最佳實踐 🎯

**原理：**
- 小資料集（< 1000 筆）：使用 Edge Functions
- 中等資料集（1000-5000 筆）：使用分塊 Edge Functions
- 大量資料集（> 5000 筆）：使用 Inngest 或 n8n

**優點：**
- ✅ 最靈活
- ✅ 針對不同場景優化
- ✅ 成本效益最佳

## 🛠️ 實作建議

### 實作 1：智能分塊 Edge Function

Edge Function 會：
1. 檢查剩餘資料量
2. 如果 > 500 筆，只處理 500 筆
3. 更新進度
4. 觸發下一個 Edge Function 繼續處理

### 實作 2：增量同步

對於 Transaction 類資料：
1. 使用 `lastModifiedDate` 只同步變更的資料
2. 初次同步時才處理全部資料
3. 後續同步只處理增量

### 實作 3：批次處理優化

1. **減少 API 呼叫**：使用 NetSuite 的批量查詢（如果支援）
2. **並發優化**：動態調整並發數（根據錯誤率）
3. **快取策略**：快取不常變動的參考資料

## 📊 效能對比

### 10,000 筆 Invoice

| 方案 | 執行時間 | 可靠性 | 成本 |
|------|---------|--------|------|
| 單次 Edge Function | ❌ 超時（60秒限制） | 低 | 免費 |
| 分塊 Edge Functions | 5-8 分鐘 | 高 | 免費 |
| Inngest | 3-5 分鐘 | 高 | 免費（有限額） |
| n8n | 2-4 分鐘 | 高 | 自架免費 |

### 50,000 筆 Sales Order

| 方案 | 執行時間 | 可靠性 | 成本 |
|------|---------|--------|------|
| 單次 Edge Function | ❌ 超時 | 低 | 免費 |
| 分塊 Edge Functions | 25-40 分鐘 | 高 | 免費 |
| Inngest | 15-25 分鐘 | 高 | 免費（有限額） |
| n8n | 10-20 分鐘 | 高 | 自架免費 |

## 🎯 推薦實施順序

### 階段 1：立即實施（今天）
1. ✅ 實作分塊處理邏輯
2. ✅ 更新 Edge Function 支援分塊
3. ✅ 前端顯示分塊進度

### 階段 2：中期優化（1 週內）
1. ✅ 實作增量同步（使用 `lastModifiedDate`）
2. ✅ 優化批次處理邏輯
3. ✅ 添加錯誤恢復機制

### 階段 3：長期方案（1 個月內）
1. ✅ 評估並整合 Inngest（如果需要）
2. ✅ 或使用 n8n 作為同步引擎
3. ✅ 監控和優化效能

## 🔧 技術細節

### 分塊處理的關鍵點

1. **狀態管理**：使用 `sync_tasks` 表儲存進度
   - `processed_count`: 已處理筆數
   - `total_records`: 總筆數
   - `chunk_size`: 每塊大小

2. **觸發機制**：Edge Function 完成後
   - 檢查是否還有未處理資料
   - 如果有，觸發下一個 Edge Function

3. **錯誤處理**：
   - 如果某塊失敗，記錄錯誤
   - 下次同步時從失敗點繼續

### 增量同步邏輯

```typescript
// 只同步最近變更的資料
const lastSyncDate = subscription.last_sync_at
const query = `lastModifiedDate > ${lastSyncDate}`

// 初次同步時，last_sync_at 為 null，同步全部
```

## 📝 實施檢查清單

- [ ] 實作分塊處理邏輯
- [ ] 更新 Edge Function 支援分塊
- [ ] 添加增量同步選項
- [ ] 前端顯示分塊進度
- [ ] 測試 10,000 筆資料
- [ ] 測試 50,000 筆資料
- [ ] 優化錯誤處理
- [ ] 添加監控和日誌


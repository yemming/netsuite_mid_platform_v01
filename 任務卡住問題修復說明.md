# 任務卡住問題修復說明

## 🔍 問題診斷

### 現象：
- 任務狀態：`running`
- 進度：`0/204 (0%)`
- 運行時間：**已超過 14 分鐘**（異常）
- 前端顯示：一直卡在「同步中」，沒有進度更新

### 根本原因：

從日誌和代碼分析，發現問題：

1. **`sync-netsuite` 觸發了 `sync-netsuite-chunked`**
   - 日誌顯示：「[account] 已觸發分塊處理 Edge Function」
   - 記錄數：294（或 204）

2. **但 `sync-netsuite-chunked` 可能沒有正確執行**
   - 可能返回了 401（Edge Function 之間調用的認證問題）
   - 或者執行了但沒有更新進度

3. **代碼邏輯問題**
   - `sync-netsuite-chunked` 在處理 `allItemIds` 時有邏輯錯誤
   - 在 `chunkIndex === 0` 時，將 `allItemIds = syncableItemIds`（過濾後的）
   - 但後續分塊時需要使用原始的 `allItemIds`
   - 這導致數據不一致

## ✅ 已修復

### 1. **修復 `allItemIds` 處理邏輯**

#### 之前（錯誤）：
```typescript
// chunkIndex === 0 時
allItemIds = syncableItemIds  // ❌ 替換為過濾後的列表

// 後續分塊時
const chunk = allItemIds.slice(startIndex, endIndex)  // ❌ 使用錯誤的列表
```

#### 現在（正確）：
```typescript
// chunkIndex === 0 時
// 保持 allItemIds 為原始列表（包含跳過的記錄）
// 保存到 metadata：{ allItemIds, syncableItemIds }

// 計算分塊時
// 重新過濾已跳過的記錄
const skippedItemIds = new Set(...)
const itemsToProcess = allItemIds.filter((id) => !skippedItemIds.has(id))
const chunk = itemsToProcess.slice(startIndex, endIndex)  // ✅ 使用正確的列表
```

### 2. **改進錯誤處理和日誌**
- 添加詳細日誌，記錄 `allItemIds` 的狀態
- 確保 `allItemIds` 正確傳遞給後續分塊
- 如果 `allItemIds` 為空，立即失敗任務（不再卡住）

### 3. **自動重置卡住的任務**
- 任務超過 15 分鐘且沒有進度，自動標記為失敗
- 避免任務永遠卡在 `running` 狀態

## 📋 修復內容

### `sync-netsuite-chunked/index.ts`

1. **改進 `allItemIds` 初始化**
   ```typescript
   // 如果提供了 savedItemIds，使用它；否則重新獲取
   let allItemIds: string[] = savedItemIds || []
   
   if (chunkIndex === 0) {
     if (allItemIds.length === 0) {
       // 重新獲取...
     } else {
       console.log(`使用提供的 allItemIds (${allItemIds.length} 筆)`)
     }
   }
   ```

2. **保持 `allItemIds` 為原始列表**
   ```typescript
   // 不應該將 allItemIds 替換為 syncableItemIds
   // 保持 allItemIds 為原始列表（用於追蹤總數和後續分塊）
   // 但實際處理時使用 syncableItemIds
   ```

3. **正確計算分塊範圍**
   ```typescript
   // 每次計算分塊時，重新過濾已跳過的記錄
   const skippedItemIds = new Set(...)
   const itemsToProcess = allItemIds.filter((id) => !skippedItemIds.has(id))
   const chunk = itemsToProcess.slice(startIndex, endIndex)
   ```

## 🎯 現在的狀態

### 已重置卡住的任務
- 任務 `1e9848a3-2289-4729-b5c8-c8b6f29b48de` 已標記為 `failed`
- 錯誤訊息：「任務卡住超過 15 分鐘且沒有進度，已自動重置」

### 修復後的流程
1. `sync-netsuite` 觸發 `sync-netsuite-chunked`
2. `sync-netsuite-chunked` 正確接收 `allItemIds`
3. 正確處理分塊（使用過濾後的記錄）
4. 正確更新進度
5. 如果卡住，自動重置

## 💡 測試建議

重新測試同步：
1. **取消訂閱 Account**
2. **重新訂閱 Account**
3. **開始同步**

**預期結果：**
- ✅ 自動切換到分塊處理
- ✅ 正確接收和處理 `allItemIds`
- ✅ 進度正常更新
- ✅ 不會再卡住超過 15 分鐘

如果還有問題，檢查：
1. Edge Function 日誌（Supabase Dashboard）
2. 是否還有 401 錯誤
3. `allItemIds` 是否正確傳遞

## ✅ 總結

**修復內容：**
- ✅ 修復 `allItemIds` 處理邏輯（保持原始列表）
- ✅ 改進分塊計算（每次重新過濾）
- ✅ 添加詳細日誌（方便診斷）
- ✅ 自動重置卡住的任務（超過 15 分鐘）

**現在的狀態：**
- ✅ 任務不會再因為邏輯錯誤而卡住
- ✅ 如果卡住，會自動重置（不再無限等待）
- ✅ 更詳細的日誌（方便診斷問題）

現在可以重新測試同步了！ 🎉

# 全量備份策略說明

## 📋 策略概述

對於純備份用途的系統，採用「清空表後全量同步」策略比差異備份更簡單、更可靠。

## ✅ 為什麼選擇全量備份？

### 優點

1. **簡單直接**
   - 不需要比較資料差異
   - 不需要處理複雜的更新邏輯
   - 代碼更少，出錯機率更低

2. **資料一致性**
   - 每次同步都是完整的最新資料
   - 不會有「部分更新」導致的不一致問題
   - 避免刪除記錄的同步問題

3. **備份完整性**
   - 如果 NetSuite 中某筆記錄被刪除，備份中也會自動刪除
   - 不需要額外處理「已刪除記錄」的邏輯

4. **恢復簡單**
   - 如果需要恢復資料，直接從備份表讀取即可
   - 不需要追蹤版本或差異

### 缺點

1. **執行時間**
   - 每次都需要重新同步所有資料
   - 對於大量資料（幾萬筆）可能需要較長時間

2. **資料庫寫入**
   - 需要先刪除舊資料，再插入新資料
   - 對於非常大的表，可能會有短暫的「空窗期」

## 🔧 實現方式

### 1. API 調用時添加參數

```typescript
// 前端調用
POST /api/sync/netsuite/datasets
{
  "datasets": ["account", "currency"],
  "clearTable": true  // 啟用全量備份模式
}
```

### 2. Edge Function 自動處理

Edge Function 會：
1. 檢查 `clearTable` 參數
2. 如果為 `true`，先清空目標表
3. 然後執行正常的同步流程

### 3. 清空表的邏輯

優先順序：
1. **TRUNCATE TABLE**（最快，但需要 RPC 權限）
2. **DELETE**（較慢但更安全，不需要特殊權限）

## 📊 使用場景

### 適合全量備份的場景

- ✅ 資料量較小（< 10,000 筆）
- ✅ 同步頻率不高（每天一次或更少）
- ✅ 純備份用途，不需要實時同步
- ✅ 需要確保備份資料與 NetSuite 完全一致

### 不適合的場景

- ❌ 資料量非常大（> 100,000 筆）
- ❌ 需要頻繁同步（每小時或更頻繁）
- ❌ 需要保留歷史版本（需要時間戳記或版本控制）

## 🚀 最佳實踐

### 1. 自動化備份排程

建議設定定時任務（例如每天凌晨）：
```typescript
// 每天凌晨 2 點執行全量備份
POST /api/sync/netsuite/datasets
{
  "datasets": [], // 空陣列 = 同步所有已訂閱的資料集
  "clearTable": true
}
```

### 2. 備份前確認

對於重要資料，建議先確認：
- 檢查上次備份時間
- 確認 NetSuite 資料完整性
- 可選：先備份到另一個表作為安全網

### 3. 監控備份狀態

- 檢查 `sync_tasks` 表的狀態
- 確認 `synced_records` 與 `total_records` 匹配
- 檢查是否有錯誤訊息

## 🔍 範例：account 資料集全量備份

```typescript
// 1. 清空現有資料
TRUNCATE TABLE netsuite_account;

// 2. 從 NetSuite 取得所有記錄
// Edge Function 自動執行

// 3. 插入新資料
INSERT INTO netsuite_account (id, netsuite_id, acct_name, ...)
VALUES (...);
```

## ⚠️ 注意事項

1. **資料丟失風險**
   - 清空表會刪除所有現有資料
   - 建議在清空前確認 NetSuite 連接正常
   - 可考慮先備份到臨時表

2. **執行時間**
   - 清空大表可能需要一些時間
   - 考慮在低峰時段執行

3. **並發問題**
   - 如果同時有多個同步任務，可能會衝突
   - 系統會自動檢查並避免重複任務

## 🎯 與差異備份的比較

| 特性 | 全量備份 | 差異備份 |
|------|---------|---------|
| 實現複雜度 | ⭐ 簡單 | ⭐⭐⭐ 複雜 |
| 執行時間 | ⚠️ 較長 | ✅ 較短 |
| 資料一致性 | ✅ 完全一致 | ⚠️ 可能不一致 |
| 代碼維護 | ✅ 容易 | ⚠️ 需要持續維護 |
| 適用場景 | 備份、存檔 | 實時同步 |

## 💡 建議

對於你的用例（純備份系統），**全量備份是最佳選擇**：

1. ✅ 設定為預設模式（`clearTable: true`）
2. ✅ 每天自動執行一次
3. ✅ 監控執行狀態和錯誤
4. ✅ 定期驗證備份資料完整性

這樣可以確保備份資料始終與 NetSuite 完全一致，而且實現和維護都很簡單。

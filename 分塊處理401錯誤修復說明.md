# åˆ†å¡Šè™•ç† 401 éŒ¯èª¤ä¿®å¾©èªªæ˜

## ğŸ” å•é¡Œè¨ºæ–·

### ç¾è±¡ï¼š
- `sync-netsuite` æˆåŠŸè§¸ç™¼ `sync-netsuite-chunked`
- ä½† `sync-netsuite-chunked` è¿”å› **401 Unauthorized**
- ä»»å‹™ç‹€æ…‹å¡åœ¨ `running`ï¼Œ`synced_records: 0`
- å‰ç«¯é¡¯ç¤ºã€ŒåŒæ­¥ä¸­ã€ä½†æ²’æœ‰é€²åº¦

### æ ¹æœ¬åŸå› ï¼š
Edge Function ä¹‹é–“èª¿ç”¨æ™‚ï¼Œç’°å¢ƒè®Šæ•¸å¯èƒ½ç„¡æ³•æ­£ç¢ºè®€å–ï¼Œå°è‡´ï¼š
1. `SUPABASE_URL` ç‚ºç©ºæˆ–éŒ¯èª¤
2. `SUPABASE_SERVICE_ROLE_KEY` ç‚ºç©ºæˆ–éŒ¯èª¤
3. `sync-netsuite-chunked` é©—è­‰ Authorization header å¤±æ•— â†’ 401

## âœ… å·²ä¿®å¾©

### 1. **æ”¹é€²éŒ¯èª¤è™•ç†**
- æª¢æŸ¥ `chunkResponse.ok`
- å¦‚æœå¤±æ•—ï¼Œç«‹å³æ›´æ–°ä»»å‹™ç‹€æ…‹ç‚º `failed`
- è¿”å›è©³ç´°éŒ¯èª¤è¨Šæ¯çµ¦å‰ç«¯

### 2. **ç’°å¢ƒè®Šæ•¸è™•ç†**
- ç§»é™¤ä¸å¿…è¦çš„ fallbackï¼ˆå¯èƒ½å°è‡´ä½¿ç”¨éŒ¯èª¤çš„å€¼ï¼‰
- ä½¿ç”¨èˆ‡ç•¶å‰ Edge Function ç›¸åŒçš„ç’°å¢ƒè®Šæ•¸ï¼ˆå·²é©—è­‰å¯ç”¨ï¼‰

### 3. **è©³ç´°æ—¥èªŒ**
- æ·»åŠ ç’°å¢ƒè®Šæ•¸æª¢æŸ¥æ—¥èªŒ
- è¨˜éŒ„è§¸ç™¼åˆ†å¡Šè™•ç†çš„è©³ç´°è³‡è¨Š

## ğŸ“‹ ä¿®å¾©å…§å®¹

```typescript
// ä¹‹å‰ï¼šå¯èƒ½æœ‰ fallback å°è‡´éŒ¯èª¤å€¼
const supabaseUrl = Deno.env.get("SUPABASE_URL") || Deno.env.get("SUPABASE_PROJECT_URL") || ""

// ç¾åœ¨ï¼šä½¿ç”¨å·²é©—è­‰å¯ç”¨çš„ç’°å¢ƒè®Šæ•¸
const supabaseUrl = Deno.env.get("SUPABASE_URL") || ""
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") || ""

// æª¢æŸ¥ä¸¦è¨˜éŒ„
if (!supabaseUrl || !supabaseServiceKey) {
  console.error(`[${datasetName}] ç¼ºå°‘ Supabase è¨­å®š...`)
  // é™ç´šè™•ç†
} else {
  console.log(`[${datasetName}] æº–å‚™è§¸ç™¼åˆ†å¡Šè™•ç†...`)
  
  // æª¢æŸ¥éŸ¿æ‡‰ç‹€æ…‹
  if (!chunkResponse.ok) {
    // ç«‹å³æ›´æ–°ä»»å‹™ç‹€æ…‹ç‚ºå¤±æ•—
    await supabase.from("sync_tasks").update({
      status: "failed",
      error_message: `è§¸ç™¼åˆ†å¡Šè™•ç†å¤±æ•— (${chunkResponse.status})...`,
      completed_at: new Date().toISOString(),
    }).eq("id", taskId)
    
    return new Response(JSON.stringify({
      success: false,
      error: `è§¸ç™¼åˆ†å¡Šè™•ç†å¤±æ•—: ...`,
    }), { status: chunkResponse.status })
  }
}
```

## ğŸ¯ æ¸¬è©¦å»ºè­°

é‡æ–°åŒæ­¥ Accountï¼š
1. å–æ¶ˆè¨‚é–± Account
2. é‡æ–°è¨‚é–± Account
3. é–‹å§‹åŒæ­¥

**é æœŸçµæœï¼š**
- âœ… å¦‚æœç’°å¢ƒè®Šæ•¸æ­£ç¢ºï¼Œåˆ†å¡Šè™•ç†æœƒæ­£å¸¸å•Ÿå‹•
- âœ… å¦‚æœç’°å¢ƒè®Šæ•¸ç¼ºå¤±ï¼Œä»»å‹™æœƒç«‹å³æ¨™è¨˜ç‚ºå¤±æ•—ï¼ˆä¸å†å¡ä½ï¼‰
- âœ… å‰ç«¯æœƒé¡¯ç¤ºæ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯

## ğŸ’¡ å¦‚æœé‚„æœ‰ 401 éŒ¯èª¤

æª¢æŸ¥ Edge Function Secretsï¼š
1. é€²å…¥ Supabase Dashboard â†’ Edge Functions â†’ Settings â†’ Secrets
2. ç¢ºèªä»¥ä¸‹ Secrets å·²è¨­ç½®ï¼š
   - `SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY`

å¦‚æœ Secrets æœªè¨­ç½®æˆ–éæœŸï¼Œéœ€è¦é‡æ–°è¨­ç½®ã€‚

## âœ… ç¸½çµ

**ä¿®å¾©å…§å®¹ï¼š**
- âœ… æ”¹é€²éŒ¯èª¤è™•ç†ï¼ˆæª¢æŸ¥éŸ¿æ‡‰ç‹€æ…‹ã€ç«‹å³æ›´æ–°ä»»å‹™ç‹€æ…‹ï¼‰
- âœ… ç°¡åŒ–ç’°å¢ƒè®Šæ•¸è™•ç†ï¼ˆä½¿ç”¨å·²é©—è­‰å¯ç”¨çš„å€¼ï¼‰
- âœ… æ·»åŠ è©³ç´°æ—¥èªŒï¼ˆæ–¹ä¾¿è¨ºæ–·å•é¡Œï¼‰

**ç¾åœ¨çš„ç‹€æ…‹ï¼š**
- âœ… 401 éŒ¯èª¤ä¸æœƒå°è‡´ä»»å‹™å¡ä½ï¼ˆç«‹å³æ¨™è¨˜ç‚ºå¤±æ•—ï¼‰
- âœ… å‰ç«¯æœƒé¡¯ç¤ºæ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯
- âœ… æ›´å®¹æ˜“è¨ºæ–·å•é¡Œï¼ˆè©³ç´°æ—¥èªŒï¼‰

ç¾åœ¨å¯ä»¥é‡æ–°æ¸¬è©¦ï¼Œå¦‚æœé‚„æœ‰ 401ï¼Œè«‹æª¢æŸ¥ Edge Function Secretsï¼

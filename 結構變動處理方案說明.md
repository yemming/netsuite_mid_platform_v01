# NetSuite è³‡æ–™çµæ§‹è®Šå‹•è™•ç†æ–¹æ¡ˆ

## ğŸ¯ å•é¡Œå ´æ™¯

ç•¶ NetSuite ERP è³‡æ–™çµæ§‹è®Šå‹•æ™‚ï¼ˆä¾‹å¦‚ï¼šå®¢æˆ¶ä¸»æª”æ–°å¢æ¬„ä½ `customField_customer_loyalty_score`ï¼‰ï¼ŒSupabase è¡¨çš„çµæ§‹éœ€è¦åŒæ­¥æ›´æ–°ã€‚

## âœ… å·²å¯¦ç¾çš„è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå‹•æ…‹æ·»åŠ æ–°æ¬„ä½ï¼ˆé è¨­ï¼Œæ¨è–¦ï¼‰âœ¨

**é‹ä½œæ–¹å¼ï¼š**
1. æ¯æ¬¡åŒæ­¥æ™‚ï¼ŒEdge Function æœƒæª¢æŸ¥è¡¨çµæ§‹
2. å–å¾— NetSuite æ¨£æœ¬è¨˜éŒ„
3. å˜—è©¦æ’å…¥æ¨£æœ¬è¨˜éŒ„
4. å¦‚æœå¤±æ•—ä¸”éŒ¯èª¤æ˜¯ã€Œæ¬„ä½ä¸å­˜åœ¨ã€ï¼Œè‡ªå‹•ä½¿ç”¨ `ALTER TABLE` æ·»åŠ ç¼ºå¤±æ¬„ä½
5. ç¹¼çºŒåŒæ­¥ï¼Œæ‰€æœ‰è³‡æ–™éƒ½èƒ½æ­£ç¢ºæ’å…¥

**å„ªé»ï¼š**
- âœ… **ä¿ç•™æ­·å²è³‡æ–™**ï¼šä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™
- âœ… **åŸ·è¡Œé€Ÿåº¦å¿«**ï¼šåªæ·»åŠ æ–°æ¬„ä½ï¼Œä¸å½±éŸ¿ç¾æœ‰è³‡æ–™
- âœ… **è‡ªå‹•åŒ–**ï¼šä¸éœ€è¦æ‰‹å‹•ä»‹å…¥
- âœ… **å®‰å…¨**ï¼šä¸æœƒä¸Ÿå¤±è³‡æ–™

**é©ç”¨å ´æ™¯ï¼š**
- ç”Ÿç”¢ç’°å¢ƒ
- éœ€è¦ä¿ç•™æ­·å²è³‡æ–™
- çµæ§‹è®ŠåŒ–ä¸é »ç¹

### æ–¹æ¡ˆ 2ï¼šé‡å»ºè¡¨çµæ§‹ï¼ˆå¯é¸ï¼Œå‚™ä»½æ¨¡å¼ï¼‰

**é‹ä½œæ–¹å¼ï¼š**
```typescript
POST /api/sync/netsuite/datasets
{
  "datasets": ["customer"],
  "rebuildTable": true  // é‡å»ºè¡¨çµæ§‹
}
```

**æµç¨‹ï¼š**
1. åˆªé™¤èˆŠè¡¨ï¼ˆ`DROP TABLE`ï¼‰
2. å–å¾— NetSuite æœ€æ–°æ¨£æœ¬è¨˜éŒ„
3. æ ¹æ“šæœ€æ–°çµæ§‹é‡æ–°å‰µå»ºè¡¨
4. é‡æ–°åŒæ­¥æ‰€æœ‰è³‡æ–™

**å„ªé»ï¼š**
- âœ… **è¡¨çµæ§‹å®Œå…¨ä¸€è‡´**ï¼š100% èˆ‡ NetSuite åŒæ­¥
- âœ… **ç°¡å–®ç›´æ¥**ï¼šä¸éœ€è¦æª¢æ¸¬è®ŠåŒ–
- âœ… **é©åˆå‚™ä»½**ï¼šæ¯æ¬¡éƒ½æ˜¯å®Œæ•´çš„å…¨é‡å‚™ä»½

**ç¼ºé»ï¼š**
- âŒ **æœƒåˆªé™¤æ­·å²è³‡æ–™**ï¼šDROP TABLE æœƒæ¸…ç©ºæ‰€æœ‰è³‡æ–™
- âŒ **åŸ·è¡Œæ™‚é–“é•·**ï¼šéœ€è¦é‡æ–°åŒæ­¥æ‰€æœ‰è³‡æ–™

**é©ç”¨å ´æ™¯ï¼š**
- ç´”å‚™ä»½ç”¨é€”
- ä¸éœ€è¦ä¿ç•™æ­·å²è³‡æ–™
- å¸Œæœ›è¡¨çµæ§‹èˆ‡ NetSuite å®Œå…¨ä¸€è‡´

### æ–¹æ¡ˆ 3ï¼šæ¸…ç©ºè³‡æ–™ä½†ä¿ç•™è¡¨çµæ§‹ï¼ˆå·²å¯¦ç¾ï¼‰

**é‹ä½œæ–¹å¼ï¼š**
```typescript
POST /api/sync/netsuite/datasets
{
  "datasets": ["customer"],
  "clearTable": true  // æ¸…ç©ºè³‡æ–™ï¼Œä½†ä¿ç•™è¡¨çµæ§‹
}
```

**æµç¨‹ï¼š**
1. ä¿ç•™è¡¨çµæ§‹ï¼ˆä¸åˆªé™¤è¡¨ï¼‰
2. æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼ˆ`TRUNCATE` æˆ– `DELETE`ï¼‰
3. é‡æ–°åŒæ­¥æ‰€æœ‰è³‡æ–™

**é©ç”¨å ´æ™¯ï¼š**
- éœ€è¦æ¸…ç©ºè³‡æ–™é‡æ–°åŒæ­¥
- ä½†ä¸éœ€è¦æ”¹è®Šè¡¨çµæ§‹

## ğŸ”„ ä¸‰ç¨®æ–¹æ¡ˆçš„æ¯”è¼ƒ

| æ–¹æ¡ˆ | ä¿ç•™æ­·å²è³‡æ–™ | æ›´æ–°è¡¨çµæ§‹ | åŸ·è¡Œé€Ÿåº¦ | é©ç”¨å ´æ™¯ |
|------|------------|-----------|---------|---------|
| **å‹•æ…‹æ·»åŠ æ¬„ä½** | âœ… æ˜¯ | âœ… è‡ªå‹• | âš¡ å¿« | ç”Ÿç”¢ç’°å¢ƒï¼ˆæ¨è–¦ï¼‰ |
| **é‡å»ºè¡¨** | âŒ å¦ | âœ… æ˜¯ | ğŸŒ æ…¢ | ç´”å‚™ä»½ |
| **æ¸…ç©ºè³‡æ–™** | âŒ å¦ | âŒ å¦ | ğŸŒ æ…¢ | å…¨é‡é‡æ–°åŒæ­¥ |

## ğŸ’¡ å»ºè­°çš„ä½¿ç”¨ç­–ç•¥

### æ—¥å¸¸åŒæ­¥ï¼ˆé è¨­ï¼‰
```typescript
POST /api/sync/netsuite/datasets
{
  "datasets": ["customer", "account"],
  // ä¸è¨­ç½® rebuildTable æˆ– clearTable
  // â†’ ä½¿ç”¨å‹•æ…‹æ·»åŠ æ¬„ä½ï¼ˆä¿ç•™æ­·å²è³‡æ–™ï¼‰
}
```

**è¡Œç‚ºï¼š**
- âœ… è‡ªå‹•æª¢æ¸¬æ–°æ¬„ä½
- âœ… å‹•æ…‹æ·»åŠ ç¼ºå¤±æ¬„ä½
- âœ… ä¿ç•™æ‰€æœ‰æ­·å²è³‡æ–™
- âœ… åªåŒæ­¥è®Šå‹•çš„è¨˜éŒ„

### å®šæœŸå…¨é‡å‚™ä»½ï¼ˆå»ºè­°ï¼‰
```typescript
POST /api/sync/netsuite/datasets
{
  "datasets": ["customer", "account"],
  "rebuildTable": true,  // é‡å»ºè¡¨çµæ§‹
  "clearTable": true      // æ¸…ç©ºè³‡æ–™ï¼ˆrebuildTable æ™‚è‡ªå‹•æ¸…ç©ºï¼‰
}
```

**è¡Œç‚ºï¼š**
- âœ… åˆªé™¤èˆŠè¡¨ä¸¦é‡å»º
- âœ… è¡¨çµæ§‹èˆ‡ NetSuite å®Œå…¨ä¸€è‡´
- âœ… æ¸…ç©ºæ‰€æœ‰è³‡æ–™
- âœ… é‡æ–°åŒæ­¥æ‰€æœ‰è³‡æ–™ï¼ˆå®Œæ•´å‚™ä»½ï¼‰

### çµæ§‹è®Šå‹•å¾Œçš„è™•ç†

**å ´æ™¯ï¼š** NetSuite æ–°å¢äº† `customField_customer_loyalty_score` æ¬„ä½

**æ–¹æ³• 1ï¼šè‡ªå‹•è™•ç†ï¼ˆæ¨è–¦ï¼‰**
- ç›´æ¥åŒæ­¥ï¼Œç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬ä¸¦æ·»åŠ æ–°æ¬„ä½
- ä¸éœ€è¦ä»»ä½•æ‰‹å‹•æ“ä½œ

**æ–¹æ³• 2ï¼šæ‰‹å‹•é‡å»ºï¼ˆå¦‚æœéœ€è¦ï¼‰**
- ä½¿ç”¨ `rebuildTable: true` é¸é …
- è¡¨çµæ§‹æœƒå®Œå…¨èˆ‡ NetSuite ä¸€è‡´

## ğŸ“‹ å¯¦éš›ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1ï¼šæ—¥å¸¸å¢é‡åŒæ­¥
```typescript
// åªåŒæ­¥è®Šå‹•çš„è³‡æ–™ï¼Œè‡ªå‹•æ·»åŠ æ–°æ¬„ä½
fetch('/api/sync/netsuite/datasets', {
  method: 'POST',
  body: JSON.stringify({
    datasets: ['customer'],
  })
})
```

### ç¯„ä¾‹ 2ï¼šå®šæœŸå…¨é‡å‚™ä»½
```typescript
// é‡å»ºè¡¨ä¸¦é‡æ–°åŒæ­¥ï¼ˆå®Œæ•´å‚™ä»½ï¼‰
fetch('/api/sync/netsuite/datasets', {
  method: 'POST',
  body: JSON.stringify({
    datasets: ['customer'],
    rebuildTable: true,  // é‡å»ºè¡¨çµæ§‹
    clearTable: true     // æ¸…ç©ºè³‡æ–™ï¼ˆrebuildTable æœƒè‡ªå‹•è™•ç†ï¼‰
  })
})
```

### ç¯„ä¾‹ 3ï¼šçµæ§‹è®Šå‹•å¾Œçš„è™•ç†
```typescript
// NetSuite æ–°å¢æ¬„ä½å¾Œï¼Œè‡ªå‹•æ·»åŠ ï¼ˆæ¨è–¦ï¼‰
fetch('/api/sync/netsuite/datasets', {
  method: 'POST',
  body: JSON.stringify({
    datasets: ['customer'],
    // ä¸è¨­ç½®ä»»ä½•é¸é …
    // â†’ ç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬ä¸¦æ·»åŠ æ–°æ¬„ä½
  })
})
```

## ğŸ” æŠ€è¡“å¯¦ç¾ç´°ç¯€

### å‹•æ…‹æ·»åŠ æ¬„ä½é‚è¼¯

```typescript
// 1. å–å¾—æ¨£æœ¬è¨˜éŒ„
const sampleRecord = await netsuite.getDatasetRecord(datasetName, syncableItemIds[0])

// 2. å˜—è©¦æ’å…¥æ¨£æœ¬è¨˜éŒ„
const testRecord = transformRecordForSupabase(sampleRecord, datasetName)
const { error: testError } = await supabase.from(tableName).insert(testRecord)

// 3. å¦‚æœå¤±æ•—ä¸”æ˜¯æ¬„ä½ç¼ºå¤±ï¼Œå‹•æ…‹æ·»åŠ 
if (testError && testError.message.includes("column")) {
  // æå–ç¼ºå¤±æ¬„ä½åç¨±
  const missingColumnName = extractColumnName(testError.message)
  
  // æ¨æ–·æ¬„ä½é¡å‹
  const columnType = inferType(sampleRecord[missingColumnName])
  
  // ä½¿ç”¨ ALTER TABLE æ·»åŠ 
  await supabase.rpc('exec_sql', {
    sql_query: `ALTER TABLE ${tableName} ADD COLUMN IF NOT EXISTS "${missingColumnName}" ${columnType}`
  })
}
```

### é‡å»ºè¡¨é‚è¼¯

```typescript
// 1. åˆªé™¤èˆŠè¡¨
await supabase.rpc('exec_sql', {
  sql_query: `DROP TABLE IF EXISTS ${tableName} CASCADE`
})

// 2. å–å¾—æœ€æ–°æ¨£æœ¬è¨˜éŒ„
const sampleRecord = await netsuite.getDatasetRecord(datasetName, syncableItemIds[0])

// 3. é‡æ–°å‰µå»ºè¡¨
const createTableSQL = generateCreateTableSQL(tableName, sampleRecord)
await supabase.rpc('exec_sql', {
  sql_query: createTableSQL
})
```

## âœ… ç¸½çµ

**ä½ çš„å•é¡Œï¼š** æ˜¯å¦æ¯æ¬¡åŒæ­¥éƒ½æ‡‰è©²åˆªé™¤èˆŠè¡¨ä¸¦é‡å»ºï¼Ÿ

**ç­”æ¡ˆï¼š** è¦–æƒ…æ³è€Œå®šï¼

1. **æ—¥å¸¸ä½¿ç”¨ï¼ˆæ¨è–¦ï¼‰**ï¼šä½¿ç”¨å‹•æ…‹æ·»åŠ æ¬„ä½
   - âœ… ä¿ç•™æ­·å²è³‡æ–™
   - âœ… è‡ªå‹•è™•ç†çµæ§‹è®ŠåŒ–
   - âœ… åŸ·è¡Œé€Ÿåº¦å¿«

2. **å®šæœŸå‚™ä»½**ï¼šä½¿ç”¨é‡å»ºè¡¨
   - âœ… è¡¨çµæ§‹å®Œå…¨ä¸€è‡´
   - âœ… å®Œæ•´çš„å…¨é‡å‚™ä»½
   - âŒ æœƒåˆªé™¤æ­·å²è³‡æ–™

3. **æ··åˆä½¿ç”¨**ï¼š
   - æ—¥å¸¸åŒæ­¥ï¼šå‹•æ…‹æ·»åŠ æ¬„ä½
   - æ¯æœˆå‚™ä»½ï¼šé‡å»ºè¡¨ + æ¸…ç©ºè³‡æ–™

**ç³»çµ±ç¾åœ¨å·²ç¶“æ”¯æ´å…©ç¨®æ–¹å¼ï¼Œä½ å¯ä»¥æ ¹æ“šéœ€æ±‚é¸æ“‡ï¼** ğŸ¯

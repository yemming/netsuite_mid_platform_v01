# è‡ªå‹•åˆ†å¡Šè™•ç†é…ç½®èªªæ˜

## ğŸ¯ è‡ªå‹•é¸æ“‡é‚è¼¯

ç³»çµ±ç¾åœ¨æœƒ**è‡ªå‹•**æ ¹æ“šè³‡æ–™é›†ç‰¹æ€§é¸æ“‡æœ€é©åˆçš„è™•ç†æ–¹å¼ï¼š

### é¸æ“‡æ¨™æº–

| æ¢ä»¶ | ä½¿ç”¨æ–¹å¼ | åŸå›  |
|------|---------|------|
| Transaction é¡è³‡æ–™é›† | åˆ†å¡Šè™•ç† | é€šå¸¸è³‡æ–™é‡å¾ˆå¤§ï¼ˆå¹¾åƒåˆ°å¹¾è¬ç­†ï¼‰ |
| è¨˜éŒ„æ•¸ > 200 ç­† | åˆ†å¡Šè™•ç† | ç¢ºä¿èƒ½åœ¨ 60 ç§’å…§å®Œæˆæ‰€æœ‰è³‡æ–™ |
| å…¨é‡å‚™ä»½æ¨¡å¼ (`clearTable: true`) | åˆ†å¡Šè™•ç† | ç¢ºä¿å®Œæ•´åŒæ­¥æ‰€æœ‰è³‡æ–™ |
| è¨˜éŒ„æ•¸ â‰¤ 200 ç­†ä¸”é Transaction | ä¸€æ¬¡æ€§è™•ç† | å°è³‡æ–™é›†ï¼Œå–®æ¬¡è™•ç†æ›´å¿« |

### Transaction é¡è³‡æ–™é›†åˆ—è¡¨

ç³»çµ±æœƒè‡ªå‹•å°‡ä»¥ä¸‹è³‡æ–™é›†è¦–ç‚º Transaction é¡ï¼š
- `invoice`
- `salesorder`
- `estimate`
- `purchaseorder`
- `itemfulfillment`
- `itemreceipt`
- `cashsale`
- `creditmemo`
- `customerpayment`
- `vendorpayment`
- `journalentry`

## ğŸ“Š å¯¦éš›æ¡ˆä¾‹

### Account è³‡æ–™é›†ï¼ˆ204 ç­†ï¼‰

**ä¹‹å‰çš„è¡Œç‚ºï¼š**
- ä½¿ç”¨ä¸€æ¬¡æ€§è™•ç† (`sync-netsuite`)
- åœ¨ 60 ç§’å…§åªèƒ½è™•ç† 67 ç­†ï¼ˆç´„ 33%ï¼‰
- å‰©é¤˜è³‡æ–™æœªåŒæ­¥

**ç¾åœ¨çš„è¡Œç‚ºï¼š**
- è‡ªå‹•é¸æ“‡åˆ†å¡Šè™•ç† (`sync-netsuite-chunked`)
- æ¯æ¬¡è™•ç† 500 ç­†ï¼Œè‡ªå‹•è§¸ç™¼ä¸‹ä¸€å€‹ chunk
- å¯ä»¥å®Œæ•´åŒæ­¥æ‰€æœ‰ 204 ç­†è³‡æ–™

### è§¸ç™¼æ¢ä»¶

å°æ–¼ accountï¼ˆ204 ç­†ï¼‰ï¼Œæœƒè§¸ç™¼åˆ†å¡Šè™•ç†å› ç‚ºï¼š
1. âœ… è¨˜éŒ„æ•¸ > 200ï¼ˆ204 > 200ï¼‰
2. âœ… å¦‚æœ `clearTable: true`ï¼Œä¹Ÿæœƒè§¸ç™¼åˆ†å¡Šè™•ç†

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### API Route é¸æ“‡é‚è¼¯

```typescript
// app/api/sync/netsuite/datasets/route.ts

const isTransactionDataset = [
  'invoice', 'salesorder', ...
].includes(datasetName.toLowerCase());

const lastSyncCount = lastSync?.last_sync_count || 0;

// è‡ªå‹•é¸æ“‡é‚è¼¯
const useChunked = 
  isTransactionDataset ||  // Transaction é¡
  lastSyncCount > 200 ||    // è¨˜éŒ„æ•¸ > 200
  clearTable;               // å…¨é‡å‚™ä»½æ¨¡å¼

const edgeFunctionName = useChunked 
  ? 'sync-netsuite-chunked'  // åˆ†å¡Šè™•ç†
  : 'sync-netsuite';         // ä¸€æ¬¡æ€§è™•ç†
```

### åˆ†å¡Šè™•ç†æµç¨‹

1. **ç¬¬ä¸€å€‹ Chunk (chunkIndex = 0)**
   - å–å¾—æ‰€æœ‰è¨˜éŒ„ ID
   - å¦‚æœ `clearTable: true`ï¼Œæ¸…ç©ºè¡¨
   - è™•ç†å‰ 500 ç­†
   - è§¸ç™¼ä¸‹ä¸€å€‹ chunk

2. **å¾ŒçºŒ Chunks (chunkIndex > 0)**
   - å¾ metadata è®€å–æ‰€æœ‰è¨˜éŒ„ ID
   - è™•ç†ç•¶å‰åˆ†å¡Šçš„ 500 ç­†
   - å¦‚æœé‚„æœ‰æ›´å¤šï¼Œè§¸ç™¼ä¸‹ä¸€å€‹ chunk

3. **æœ€å¾Œä¸€å€‹ Chunk**
   - è™•ç†å‰©é¤˜è³‡æ–™
   - æ¨™è¨˜ä»»å‹™ç‚º `completed`

## ğŸš€ ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1ï¼šé€šé API Routeï¼ˆæ¨è–¦ï¼‰

```typescript
POST /api/sync/netsuite/datasets
{
  "datasets": ["account", "currency"],
  "clearTable": true  // å…¨é‡å‚™ä»½æ¨¡å¼
}
```

ç³»çµ±æœƒè‡ªå‹•ï¼š
- æ ¹æ“šè³‡æ–™é›†ç‰¹æ€§é¸æ“‡è™•ç†æ–¹å¼
- Account (204 ç­†) â†’ è‡ªå‹•ä½¿ç”¨åˆ†å¡Šè™•ç†
- Currency (8 ç­†) â†’ è‡ªå‹•ä½¿ç”¨ä¸€æ¬¡æ€§è™•ç†

### æ–¹å¼ 2ï¼šç›´æ¥èª¿ç”¨ Edge Function

```typescript
// åˆ†å¡Šè™•ç†
POST /functions/v1/sync-netsuite-chunked
{
  "taskId": "unique-id",
  "datasetName": "account",
  "chunkIndex": 0,
  "clearTable": true
}

// ä¸€æ¬¡æ€§è™•ç†
POST /functions/v1/sync-netsuite
{
  "taskId": "unique-id",
  "datasetName": "currency",
  "clearTable": true
}
```

## ğŸ“ˆ æ•ˆèƒ½å°æ¯”

### Account è³‡æ–™é›†ï¼ˆ204 ç­†ï¼‰

| æ–¹å¼ | åŸ·è¡Œæ™‚é–“ | åŒæ­¥ç‡ | ç‹€æ…‹ |
|------|---------|--------|------|
| ä¸€æ¬¡æ€§è™•ç† | ~60 ç§’ | 67/204 (33%) | âš ï¸ éƒ¨åˆ†å®Œæˆ |
| åˆ†å¡Šè™•ç† | ~30-60 ç§’/chunk | 204/204 (100%) | âœ… å®Œæ•´åŒæ­¥ |

**çµè«–ï¼š** åˆ†å¡Šè™•ç†ç¢ºä¿å®Œæ•´åŒæ­¥ï¼Œé›–ç„¶éœ€è¦å¤šæ¬¡èª¿ç”¨ï¼Œä½†ç¸½æ™‚é–“ç›¸è¿‘ã€‚

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. è®“ç³»çµ±è‡ªå‹•é¸æ“‡

ä¸éœ€è¦æ‰‹å‹•æŒ‡å®šä½¿ç”¨å“ªå€‹ Edge Functionï¼Œç³»çµ±æœƒæ ¹æ“šï¼š
- è³‡æ–™é›†é¡å‹
- è¨˜éŒ„æ•¸é‡
- åŒæ­¥æ¨¡å¼

è‡ªå‹•é¸æ“‡æœ€é©åˆçš„æ–¹å¼ã€‚

### 2. å…¨é‡å‚™ä»½æ¨¡å¼

å°æ–¼å‚™ä»½ç”¨é€”ï¼Œå»ºè­°ï¼š
```typescript
{
  "datasets": [],
  "clearTable": true  // é è¨­å•Ÿç”¨å…¨é‡å‚™ä»½
}
```

### 3. ç›£æ§åŒæ­¥é€²åº¦

```typescript
GET /api/sync/netsuite/tasks?dataset_name=account
```

å¯ä»¥æŸ¥çœ‹ï¼š
- ç•¶å‰é€²åº¦ (`synced_records / total_records`)
- ä»»å‹™ç‹€æ…‹ (`pending`, `running`, `completed`, `failed`)
- éŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚æœæœ‰ï¼‰

## âš ï¸ æ³¨æ„äº‹é …

1. **åŸ·è¡Œæ™‚é–“**
   - åˆ†å¡Šè™•ç†éœ€è¦å¤šæ¬¡ Edge Function èª¿ç”¨
   - æ¯å€‹ chunk æœ€å¤š 50 ç§’
   - ç¸½æ™‚é–“ = chunk æ•¸é‡ Ã— 50 ç§’ï¼ˆå¯¦éš›ä¸Šæœƒæ›´å¿«ï¼‰

2. **æ¸…ç©ºè¡¨æ™‚æ©Ÿ**
   - åªåœ¨ç¬¬ä¸€å€‹ chunk (chunkIndex = 0) æ™‚æ¸…ç©º
   - é¿å…åœ¨è™•ç†éç¨‹ä¸­æ¸…ç©ºï¼Œå°è‡´è³‡æ–™ä¸Ÿå¤±

3. **éŒ¯èª¤æ¢å¾©**
   - å¦‚æœæŸå€‹ chunk å¤±æ•—ï¼Œå¯ä»¥æ‰‹å‹•è§¸ç™¼è©² chunk
   - ç³»çµ±æœƒè‡ªå‹•è·³éå·²åŒæ­¥çš„è¨˜éŒ„ï¼ˆä½¿ç”¨ `upsert`ï¼‰

## ğŸ¯ ç¸½çµ

ç¾åœ¨ç³»çµ±æœƒ**è‡ªå‹•**ï¼š
- âœ… æ ¹æ“šè³‡æ–™é‡é¸æ“‡æœ€é©åˆçš„è™•ç†æ–¹å¼
- âœ… Account (204 ç­†) â†’ è‡ªå‹•ä½¿ç”¨åˆ†å¡Šè™•ç†
- âœ… Currency (8 ç­†) â†’ è‡ªå‹•ä½¿ç”¨ä¸€æ¬¡æ€§è™•ç†
- âœ… å…¨é‡å‚™ä»½æ¨¡å¼ â†’ è‡ªå‹•ä½¿ç”¨åˆ†å¡Šè™•ç†ï¼ˆç¢ºä¿å®Œæ•´åŒæ­¥ï¼‰

**ä½ ä¸éœ€è¦æ‰‹å‹•é¸æ“‡ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†ï¼** ğŸš€

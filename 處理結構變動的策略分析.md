# NetSuite 資料結構變動處理策略分析

## 🔍 問題描述

### 情境
假設 NetSuite 的客戶主檔新增了一個欄位（例如：`customField_customer_loyalty_score`），那麼：
- NetSuite API 返回的記錄會包含這個新欄位
- 但 Supabase 表的結構還是舊的（沒有這個欄位）
- 同步時會發生什麼？

### 目前的問題

1. **欄位遺失**：新欄位的值會被忽略（因為表中沒有該欄位）
2. **資料不完整**：雖然不會報錯，但資料不完整
3. **需要手動維護**：需要手動 ALTER TABLE 添加欄位

## 💡 解決方案比較

### 方案 1：重建表（你建議的）

**優點：**
- ✅ 表結構永遠與 NetSuite 一致
- ✅ 簡單直接，不需要檢測變化
- ✅ 確保資料完整

**缺點：**
- ❌ **資料丟失風險**：DROP TABLE 會刪除所有歷史資料
- ❌ **執行時間長**：每次同步都要重建表
- ❌ **索引重建**：需要重新建立所有索引
- ❌ **約束重建**：需要重新建立 UNIQUE、FOREIGN KEY 等

**適用場景：**
- 純備份用途（不需要歷史資料）
- 資料結構變化頻繁
- 可以接受每次全量同步

### 方案 2：動態 ALTER TABLE（推薦）

**優點：**
- ✅ 保留歷史資料
- ✅ 只添加新欄位，不影響現有資料
- ✅ 執行時間短
- ✅ 不會丟失資料

**缺點：**
- ❌ 需要檢測結構變化
- ❌ 刪除的欄位無法自動處理（但 NetSuite 通常不會刪除欄位）
- ❌ 邏輯較複雜

**適用場景：**
- 生產環境
- 需要保留歷史資料
- 資料結構變化不頻繁

### 方案 3：混合方案（最佳實踐）

**策略：**
1. **檢測結構變化**：比較樣本記錄與表結構
2. **動態更新**：使用 ALTER TABLE ADD COLUMN（如果欄位不存在）
3. **可選：全量重建**：提供 `clearTable: true` 選項（備份模式）
4. **metadata 備份**：完整記錄存在 `metadata` JSONB 欄位中

**優點：**
- ✅ 靈活：可以選擇保留或重建
- ✅ 安全：默認保留資料，可選重建
- ✅ 完整：metadata 存儲完整原始資料

## 🎯 推薦實現方案

### 智能結構同步（方案 3）

```typescript
// 1. 檢測新欄位
const newColumns = detectNewColumns(sampleRecord, existingColumns)

// 2. 動態添加新欄位
if (newColumns.length > 0) {
  for (const col of newColumns) {
    await supabase.rpc('exec_sql', {
      sql_query: `ALTER TABLE ${tableName} ADD COLUMN IF NOT EXISTS "${col.name}" ${col.type}`
    })
  }
}

// 3. metadata 欄位存儲完整資料（已實現）
baseData.metadata = record // 完整 NetSuite 記錄
```

### 可選：重建表模式

```typescript
// 如果 clearTable: true，可以選擇重建表
if (clearTable && schemaChanged) {
  // 1. 備份資料（如果需要）
  // 2. DROP TABLE
  // 3. CREATE TABLE（基於新結構）
  // 4. 重新同步資料
}
```

## 📊 效能對比

| 操作 | 重建表 | ALTER TABLE | metadata 查詢 |
|------|--------|-------------|---------------|
| 執行時間 | ~500ms | ~10ms | 0ms |
| 資料風險 | 高（全刪） | 低（只增） | 無 |
| 歷史資料 | 丟失 | 保留 | 保留 |
| 查詢便利性 | 高 | 高 | 低（需 JSONB 查詢）|

## 🔄 實際流程建議

### 場景 1：定期同步（預設行為）
```
1. 取得樣本記錄
2. 檢測表結構
3. 比較欄位差異
4. 使用 ALTER TABLE 添加新欄位
5. 同步資料
6. 完整資料存儲在 metadata（備份）
```

### 場景 2：全量備份（clearTable: true）
```
1. 取得樣本記錄
2. 重建表結構（DROP + CREATE）
3. 清空所有資料
4. 重新同步所有資料
```

## ✅ 建議的實現

1. **預設行為**：使用 ALTER TABLE 添加新欄位（保留資料）
2. **可選選項**：提供 `rebuildTable: true` 選項（重建表）
3. **備份機制**：metadata 欄位存儲完整原始資料（已實現）
4. **日誌記錄**：記錄結構變化，方便追蹤

## 🎯 總結

**對於你的用例（備份為主）：**
- ✅ 可以使用 `clearTable: true` + 重建表（已實現）
- ✅ 或者使用 ALTER TABLE 動態更新（推薦實現）

**建議：**
- 實現動態結構更新（ALTER TABLE）
- 保留 `clearTable` 選項作為備份模式
- 兩者結合使用最靈活
